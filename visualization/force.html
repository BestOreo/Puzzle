<!DOCTYPE html>
<meta charset="utf-8">
<style>
    rect {
        fill: none;
        pointer-events: all;
    }
    
    .node {
        fill: gold;
    }
    
    .cursor {
        fill: none;
        stroke: brown;
        pointer-events: none;
    }
    
    .link {
        stroke: #999;
    }
    
    text {
        font: 12px Microsoft YaHei;
        pointer-events: none;
        text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
    }
</style>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>
        var width = document.body.clientWidth,
            height = 500;

        var fill = d3.scale.category20();

        var force = d3.layout.force()
            .size([width, height])
            .nodes([{}]) // initialize with a single node
            .linkDistance(100)
            .charge(-1000)
            .on("tick", tick);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("mousemove", mousemove)
            .on("mousedown", mousedownCanvas);

        svg.append("rect")
            .attr("width", width)
            .attr("height", height);

        var nodes = force.nodes(),
            links = force.links(),
            node = svg.selectAll(".node"),
            link = svg.selectAll(".link");

        var node_r = 20;

        var cursor = svg.append("circle")
            .attr("r", node_r)
            .attr("transform", "translate(-100,-100)")
            .attr("class", "cursor");


        var edges_text = svg.append("g").selectAll(".edgelabel")
            .data(force.links())
            .enter()
            .append("text")
            .style("pointer-events", "none")
            //.attr("class","linetext")
            .attr({
                'class': 'edgelabel',
                'id': function(d, i) {
                    return 'edgepath' + i;
                },
                'dx': 80,
                'dy': 0
            });
        //设置线条上的文字
        edges_text.append('textPath')
            .attr('xlink:href', function(d, i) {
                return '#edgepath' + i
            })
            .style("pointer-events", "none")
            .text(function(d) {
                return d.rela;
            });

        restart();



        function mousemove() {
            cursor.attr("transform", "translate(" + d3.mouse(this) + ")");
        }


        var mode = 0; // 0代表拖拉 1代表增值

        document.onkeydown = function(event) {
            var e = event || window.event || arguments.callee.caller.arguments[0];
            if (e && e.keyCode == 81) { // 按 Esc 
                mode = 1 - mode;
            }
        };

        function mousedownCanvas() {
            if (mode == 0) {} else {
                var point = d3.mouse(this),
                    node = {
                        x: point[0],
                        y: point[1],
                        name: "AAA"
                    };

                nodes.forEach(function(target) {
                    var x = target.x - node.x,
                        y = target.y - node.y;
                    if (x * x + y * y < node_r * node_r) {
                        n = nodes.push(node);
                        links.push({
                            source: node,
                            target: target
                        });
                    }
                });
                restart();
            }
        }

        function mousedownNode(respondNode, index) {
            // var point = d3.mouse(this),
            //     node = {
            //         x: point[0],
            //         y: point[1]
            //     },
            //     n = nodes.push(node);

            // links.push({
            //     source: respondNode,
            //     target: node
            // });
            // nodes.splice(i, 1);
            // links = links.filter(function(l) {
            //     return l.source !== d && l.target !== d;
            // });
            // d3.event.stopPropagation();

            restart();
        }

        function tick() {
            link.attr("x1", function(d) {
                    return d.source.x;
                })
                .attr("y1", function(d) {
                    return d.source.y;
                })
                .attr("x2", function(d) {
                    return d.target.x;
                })
                .attr("y2", function(d) {
                    return d.target.y;
                });

            node.attr("cx", function(d) {
                    return d.x;
                })
                .attr("cy", function(d) {
                    return d.y;
                });
        }

        function restart() {
            node = node.data(nodes);

            node.enter().insert("circle", ".cursor")
                .attr("class", "node")
                .attr("r", 20)
                .on("mousedown", mousedownNode)
                .call(force.drag);

            node.exit()
                .remove();

            link = link.data(links);

            link.enter().insert("line", ".node")
                .attr("class", "link");
            link.exit()
                .remove();

            force.start();
        }
    </script>