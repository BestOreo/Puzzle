<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/nav/nav.css">

    <script src="https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/angular.js/1.4.6/angular.min.js"></script>
    <script src="/js/manual/xlsx.full.min.js"></script>

    <style>
        button{
            width: 100px;
        }
    </style>
</head>


<body>
    <div class="header-wrapper" style="margin-bottom: 50px">
        <header>
            <div class="container">
                <div class="logo-container">
                    <a href="/"><span class="tag-line">知识图谱-Puzzle</span> </a>
                </div>
                <!-- Start of Main Navigation -->
                <nav class="main-nav">
                    <div class="menu-top-menu-container">
                        <ul id="menu-top-menu" class="clearfix">
                            <li><a href="/display">可视化</a></li>
                            <li><a href="/3dnodes">3D视图</a></li>
                            <li><a href="/robot">智能问答</a></li>
                            <li><a href="/manual">编辑</a></li>
                            <li><a href="#contact">联系</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
    </div>
    <h3 style="text-align: center; margin-bottom: 40px">创建关联信息</h3>

    <div style="width: 70%;margin:0 auto">
        <div style="margin-top:-15px; width: 15%; float: right;">
            <button type="button" class="btn btn-xs btn-link" onclick="addtr()">添加</button>
        </div>
        <table class="table  table-bordered table-striped" id="para_table">
            <tbody>
                <tr class="warning">
                    <th style="text-align:center" width="200">源节点</th>
                    <th style="text-align:center" width="200">属性</th>
                    <th style="text-align:center" width="200">目标节点</th>
                    <th style="text-align:center" width="100">操作</th>
                </tr>
                <!--<tr>-->
                    <!--<td style="text-align:center; " onclick="tdclick(this)"></td>-->
                    <!--<td style="text-align:center; " onclick="tdclick(this)"></td>-->
                    <!--<td style="text-align:center; " onclick="tdclick(this)"></td>-->
                    <!--<td style="text-align:center; " onclick="deletetr(this)">-->
                        <!--<button type="button" class="btn btn-xs btn-link">删除</button>-->
                    <!--</td>-->
                <!--</tr>-->
            </tbody>
        </table>
        <div style="margin-top:-15px; width: 15%; float: right;">
            <button type="button" class="btn btn-xs btn-link" onclick="addtr()">添加</button>
        </div>
    </div>

    <div style="text-align:center; margin-top: 50px">
        <button id="upload" type="button" class="btn btn-warning">导入Excel</button>
        <button type="button" class="btn btn-warning">导出Excel</button>
        <button type="button" class="btn btn-primary">提交</button>
    </div>


    <div id="demo"></div>

    <script>
        $('#upload').after('<input id="load_xls" style="display: none" type="file" onchange="importf(this)" />');
        $('#upload').click(function(){
            document.getElementById("load_xls").click();
        });
    </script>


    <script type="text/javascript">
        function save_para_table() {

            var tableinfo = gettableinfo();
            alert(tableinfo);


        }
        //get table infomation
        function gettableinfo() {
            var key = "";
            var value = "";
            var tabledata = "";
            var table = $("#para_table");
            var tbody = table.children();
            var trs = tbody.children();
            for (var i = 1; i < trs.length; i++) {
                var tds = trs.eq(i).children();
                for (var j = 0; j < tds.length; j++) {
                    if (j == 0) {
                        if (tds.eq(j).text() == null || tds.eq(j).text() == "") {
                            return null;
                        }
                        key = "key\":\"" + tds.eq(j).text();
                    }
                    if (j == 1) {
                        if (tds.eq(j).text() == null || tds.eq(j).text() == "") {
                            return null;
                        }
                        value = "value\":\"" + tds.eq(j).text();
                    }
                }
                if (i == trs.length - 1) {
                    tabledata += "{\"" + key + "\",\"" + value + "\"}";
                } else {
                    tabledata += "{\"" + key + "\",\"" + value + "\"},";
                }
            }
            tabledata = "[" + tabledata + "]";
            return tabledata;
        }

        function tdclick(tdobject) {
            var td = $(tdobject);
            td.attr("onclick", "");
            //1,取出当前td中的文本内容保存起来
            var text = td.text();
            //2,清空td里面的内容
            td.html(""); //也可以用td.empty();
            //3，建立一个文本框，也就是input的元素节点
            var input = $("<input>");
            //4，设置文本框的值是保存起来的文本内容
            input.attr("width", "400");
            input.attr("value", text);
            input.bind("blur", function() {
                var inputnode = $(this);
                var inputtext = inputnode.val();
                var tdNode = inputnode.parent();
                tdNode.html(inputtext);
                tdNode.click(tdclick);
                td.attr("onclick", "tdclick(this)");
            });
            input.keyup(function(event) {
                var myEvent = event || window.event;
                var kcode = myEvent.keyCode;
                if (kcode == 13) {
                    var inputnode = $(this);
                    var inputtext = inputnode.val();
                    var tdNode = inputnode.parent();
                    tdNode.html(inputtext);
                    tdNode.click(tdclick);
                }
            });

            //5，将文本框加入到td中
            td.append(input);
            var t = input.val();
            input.val("").focus().val(t);
            //              input.focus();

            //6,清除点击事件
            td.unbind("click");
        }

        function addtr() {
            var table = $("#para_table");
            var tr = $("<tr>" +
                "<td  onclick='tdclick(this)'>" + "</td>" +
                "<td  onclick='tdclick(this)'>" + "</td>" +
                "<td  onclick='tdclick(this)'>" + "</td>" +
                "<td  align='center' onclick='deletetr(this)'><button type='button'  class='btn btn-xs btn-link' >" + "删除" + "</button></td></tr>");
            table.append(tr);
        }

        function deletetr(tdobject) {
            var td = $(tdobject);
            td.parents("tr").remove();
        }
    </script>

    <script>
        /*
         FileReader共有4种读取方法：
         1.readAsArrayBuffer(file)：将文件读取为ArrayBuffer。
         2.readAsBinaryString(file)：将文件读取为二进制字符串
         3.readAsDataURL(file)：将文件读取为Data URL
         4.readAsText(file, [encoding])：将文件读取为文本，encoding缺省值为'UTF-8'
         */
        var wb;//读取完成的数据
        var rABS = false; //是否将文件读取为二进制字符串

        function importf(obj) {//导入
            if(!obj.files) {
                return;
            }
            var f = obj.files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = e.target.result;
                if(rABS) {
                    wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                        type: 'base64'
                    });
                } else {
                    wb = XLSX.read(data, {
                        type: 'binary'
                    });
                }
                //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
                //wb.Sheets[Sheet名]获取第一个Sheet的数据
//                document.getElementById("demo").innerHTML= JSON.stringify( XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]) );
                var jsons = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                jsons.forEach(function (data) {
                    console.log(data);
                    var table = $("#para_table");
                    var tr = $("<tr>" +
                        "<td  onclick='tdclick(this)'>" +data["source"]+ "</td>" +
                        "<td  onclick='tdclick(this)'>" +data["link"]+ "</td>" +
                        "<td  onclick='tdclick(this)'>" +data["destination"]+ "</td>" +
                        "<td  align='center' onclick='deletetr(this)'><button type='button'  class='btn btn-xs btn-link' >" + "删除" + "</button></td></tr>");
                    table.append(tr);
                });
                wb = null;
                $("#load_xls").val("");
            };
            if(rABS) {
                reader.readAsArrayBuffer(f);
            } else {
                reader.readAsBinaryString(f);
            }
        }

        function fixdata(data) { //文件流转BinaryString
            var o = "",
                l = 0,
                w = 10240;
            for(; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
            o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
            return o;
        }
    </script>

</body>

</html>